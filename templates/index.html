{% extends 'base.html' %}

{% block title %}运营线路{% endblock %}

{% block header_subtitle %}
{% endblock %}

{% block page_title %}
    <div class="next-station-title">
        <div class="next-topline">
            <span class="next-station-label">下一站</span>
            <span class="next-station-label" style="font-size: 12px;">Next Station</span>
            {% if transfer_badges and transfer_badges|length > 0 %}
            <div class="next-station-transfers">
                <span class="transfer-label">换乘</span>
                <span class="transfer-label" style="font-size: 13px;">Transfer</span>
                <span class="next-transfer-badges">
                    {% for b in transfer_badges %}
                    <span class="transfer-badge {% if b.code|string|length > 1 %}wide{% endif %}" data-color="{{ b.color }}">{{ b.code }}</span>
                    {% endfor %}
                </span>
            </div>
            {% endif %}
        </div>
        <span class="next-station-name">{{ next_station }}</span>
        <span class="next-station-name-en">{{ trans_data.get(next_station, next_station).replace('<br>', ' ') }}</span>
    </div>
{% endblock %}

{% block head %}
<style>
    .next-station-title {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }
    .next-topline { display: inline-flex; align-items: center; gap: 10px; }
    .next-station-label {
        font-size: 18px;
        color: #fff;
        opacity: 0.9;
    }
    .transfer-label { font-size: 18px; color: #fff; opacity: 0.9; font-weight: normal; }
    .next-station-name {
        font-size: 32px;
        font-weight: bold;
        color: #fff;
    }
    .next-station-name-en {
        font-size: 16px;
        color: #fff;
        opacity: 0.8;
    }
    .next-station-transfers {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #fff;
        opacity: 0.9;
    }
    .next-transfer-badges { display: inline-flex; gap: 6px; }
    .transfer-badge { width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: bold; }
    .transfer-badge.wide { width: auto; min-width: 22px; padding: 0 5px; border-radius: 11px; }

    .route-info {
        margin: 30px 0;
    }
    
    .route-line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 20px 0;
        position: relative;
        gap: 60px; /* 增加最小间距，防止长站名挤压 */
    }
    
    :root { --dot-adjust: 2.5px; --rail-adjust: -2px; --rail-thickness: 10px; }
    .route-line::before {
        content: '';
        position: absolute;
        top: calc(50% + var(--rail-adjust, 0px));
        left: var(--rail-left, 0);
        width: var(--rail-width, 100%);
        height: var(--rail-thickness, 10px);
        background-color: #e0e0e0;
        z-index: 1;
    }
    /* 单节点（环线无终点）隐藏连线 */
    .route-line.single::before {
        display: none;
    }
    
    .route-line.active::before {
        background-color: var(--theme-color);
    }
    
    .route-line .terminal-station {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        line-height: 1.2;
        font-size: 16px;
        font-weight: bold;
        padding: 5px 15px;
        background-color: white;
        border: 2px solid var(--theme-color);
        border-radius: 20px;
        z-index: 2;
        max-width: 280px; /* 限制最大宽度，防止长站名占满屏幕 */
        flex-shrink: 0;   /* 确保气泡不会被挤压变形 */
    }
    .terminal-station .term-cn { font-size: 16px; font-weight: bold; color: inherit; white-space: nowrap; }
    /* 英文站名过长时允许换行，避免撑开气泡 */
    .terminal-station .term-en { 
        font-size: 12px; 
        color: #666; 
        white-space: normal; 
        text-align: center;
        word-break: break-word;
        max-width: 100%;
    }
    /* 无终点的环线：中英文同一行显示，避免自动换行 */
    .route-line.single .terminal-station { flex-direction: row; gap: 8px; }
    .route-line.active .terminal-station { background-color: var(--theme-color); color: white; }
    .route-line.active .terminal-station .term-en { color: #fff; opacity: 0.9; }
    
    .station-indicators {
        position: absolute;
        top: calc(50% + var(--rail-adjust, 0px) - calc(var(--rail-thickness, 10px) / 2) + var(--dot-adjust, 0px));
        left: 80px;
        right: 80px;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        z-index: 2;
        padding: 0; /* 去掉左右内边距，保证可用宽度与线路一致 */
        height: 0; /* 让容器无自身高度，确保绝对居中与轨道对齐 */
    }
    
    .station-indicator {
        width: 14px; /* 适当放大，较线宽更醒目 */
        height: 14px;
        border-radius: 50%;
        background-color: var(--theme-color);
        border: 2px solid #fff;
        position: relative;
        box-shadow: 0 0 0 2px var(--theme-color) inset;
        box-sizing: border-box; /* 尺寸包含描边，避免视觉偏差 */
    }
    
    /* 使用网格对齐：所有线路共享相同的列，保证纵向对齐 */
    .station-indicators.grid {
        display: grid;
        grid-template-columns: repeat(var(--col-count, 1), 1fr);
        align-items: center;
    }
    .station-indicators.grid .station-indicator {
        justify-self: center;
    }
    
    .station-indicator.next::before {
        content: '';
        width: 8px; /* 红点随主点比例略增大 */
        height: 8px;
        background-color: #ff3b30;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: blink 1s infinite alternate;
    }
    
    .route-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
    }
    
    .route-label.active {
        color: #9b5de5;
        font-weight: bold;
    }
    
    .terminal-info {
        text-align: right;
        margin-top: 20px;
        font-size: 16px;
        color: #666;
    }
    .terminal-info strong {
        color: #9b5de5;
        font-size: 18px;
    }
    .terminal-info-en { text-align: right; margin-top: 6px; font-size: 14px; color: #666; }
    .terminal-info-en strong { color: #9b5de5; font-size: 16px; }
</style>
{% endblock %}

{% block content %}
    <!-- 路线信息展示（nextstation功能） -->
    <div class="route-info" style="--theme-color: {{ line_color or '#9b5de5' }};">
        {% if route_services %}
            {% set ns = namespace(active_group='0') %}
            {% for svc in route_services %}
                {% if svc.is_main %}
                    {% set ns.active_group = svc.group %}
                {% endif %}
            {% endfor %}
            {% set route_services_display = route_services | selectattr('group', 'equalto', ns.active_group) | list %}
            {% if route_services_display|length == 0 %}
                {% set route_services_display = route_services %}
            {% endif %}
            {% set has_multiple = route_services_display|length > 1 %}
            {% for svc in route_services_display %}
                <div class="route-label {{ 'active' if svc.is_main else '' }}">运营线路{% if has_multiple %}{{ loop.index }}{% endif %}</div>
                <div class="route-line {{ 'active' if svc.is_main else '' }} {{ 'loop' if svc.is_loop else '' }} {{ 'single' if svc.is_loop and not svc.has_terminal else '' }}" data-total="{{ svc.total }}" data-stations="{{ (svc.stations or []) | join('|') }}" data-next="{{ next_station }}" data-direction="{{ direction }}" data-terminal="{{ svc.end if svc.is_loop else terminal_station }}" data-is-loop="{{ 1 if svc.is_loop else 0 }}" data-has-terminal="{{ 1 if svc.has_terminal else 0 }}">
                     <div class="terminal-station">
                         <div class="term-cn">{{ svc.start }}</div>
                         <div class="term-en">
                             {% if svc.is_loop %}
                                 {% if direction|int == 1 %}Inner Loop{% else %}Outer Loop{% endif %}
                             {% else %}
                                 {{ trans_data.get(svc.start, svc.start).replace('<br>', ' ') }}
                             {% endif %}
                         </div>
                     </div>
                      {% if not (svc.is_loop and not svc.has_terminal) %}
                     <div class="station-indicators">
                         {% for i in range(svc.count) %}
                         <div class="station-indicator"></div>
                         {% endfor %}
                     </div>
                     <div class="terminal-station">
                         <div class="term-cn">{{ svc.end }}</div>
                         <div class="term-en">{{ trans_data.get(svc.end, svc.end).replace('<br>', ' ') }}</div>
                     </div>
                      {% endif %}
                 </div>
            {% endfor %}
        {% else %}
            <!-- 回退：仅渲染主运营线路 -->
            <div class="route-label active">运营线路</div>
            <div class="route-line active">
                <div class="terminal-station">{% if start_station %}{{ start_station }}{% endif %}</div>
                <div class="station-indicators">
                    {% for i in range(6) %}
                    <div class="station-indicator"></div>
                    {% endfor %}
                </div>
                <div class="terminal-station">{% if terminal_station %}{{ terminal_station }}{% endif %}</div>
            </div>
        {% endif %}
    </div>
    
    <div class="terminal-info">
        {% if route_services and route_services[0].is_loop %}
            {% if loop_terminal_main %}
                {{ loop_ring_label_main }} 终点站：<strong>{{ loop_terminal_main }}</strong>
            {% else %}
                <strong>{{ loop_ring_label_main }}</strong>
            {% endif %}
        {% else %}
            终点站: <strong>{% if terminal_station %}{{ terminal_station }}{% endif %}</strong>
        {% endif %}
    </div>
    <div class="terminal-info-en">
        {% if loop_ring_label_main %}
            {% if loop_terminal_main %}
                {% if loop_ring_label_main == '内环运行' %}Inner Loop{% else %}Outer Loop{% endif %} Terminal: <strong>{{ trans_data.get(loop_terminal_main, loop_terminal_main).replace('<br>', ' ') }}</strong>
            {% else %}
                {% if loop_ring_label_main == '内环运行' %}Inner Loop{% else %}Outer Loop{% endif %}
            {% endif %}
        {% else %}
            Terminal: <strong>{{ trans_data.get(terminal_station, terminal_station).replace('<br>', ' ') }}</strong>
        {% endif %}
    </div>
    

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('PIS车内导视系统首页加载完成');
        
        // 路线信息布局功能（nextstation功能）
        const routeInfo = document.querySelector('.route-info');
        if (routeInfo) {
            const theme = routeInfo?.style.getPropertyValue('--theme-color') || '#9b5de5';
            // 统一主题色描边
            document.querySelectorAll('.station-indicator').forEach(el => {
                el.style.borderColor = theme;
                el.style.boxShadow = '0 0 0 2px rgba(255,255,255,0.8) inset';
            });
            
            function layoutRouteLines() {
                const routeLines = Array.from(document.querySelectorAll('.route-line'));
                
                function computeEffectiveTotal(line) {
                    const isLoop = (line.getAttribute('data-is-loop') || '0') === '1';
                    const hasTerminal = (line.getAttribute('data-has-terminal') || '0') === '1';
                    if (!isLoop || !hasTerminal) {
                        const t = parseInt(line.getAttribute('data-total') || '0', 10);
                        return isNaN(t) ? 0 : t;
                    }
                    const stationsRaw = (line.getAttribute('data-stations') || '').split('|').map(s => s.trim()).filter(Boolean);
                    const nextName = (line.getAttribute('data-next') || '').trim();
                    const terminalName = (line.getAttribute('data-terminal') || '').trim();
                    if (!stationsRaw.length || !terminalName) {
                        const t = parseInt(line.getAttribute('data-total') || '0', 10);
                        return isNaN(t) ? 0 : t;
                    }
                    const n = stationsRaw.length;
                    let startIdx = stationsRaw.indexOf(nextName);
                    if (startIdx < 0) startIdx = 0;
                    const termIdx = stationsRaw.indexOf(terminalName);
                    if (termIdx < 0) {
                        const t = parseInt(line.getAttribute('data-total') || '0', 10);
                        return isNaN(t) ? n : t;
                    }
                    if (termIdx >= startIdx) return (termIdx - startIdx + 1);
                    return (n - startIdx + termIdx + 1);
                }
                const effectiveTotals = routeLines.map(computeEffectiveTotal);
                let maxTotal = Math.max(...effectiveTotals);
                let anchorIdx = -1;
                for (let i = 0; i < routeLines.length; i++) {
                    const single = routeLines[i].classList.contains('single');
                    if (!single && effectiveTotals[i] >= (maxTotal || 0)) { anchorIdx = i; break; }
                }
                if (anchorIdx < 0) anchorIdx = effectiveTotals.indexOf(maxTotal);
                const anchorLine = routeLines[anchorIdx];
                const anchorStart = anchorLine?.querySelector('.terminal-station:first-of-type');
                const anchorEnd = anchorLine?.querySelector('.terminal-station:last-of-type');
                const anchorRect = anchorLine?.getBoundingClientRect();
                const anchorStartCenterViewport = anchorStart ? (anchorStart.getBoundingClientRect().left + anchorStart.getBoundingClientRect().width / 2) : null;
                const anchorEndCenterViewport = anchorEnd ? (anchorEnd.getBoundingClientRect().left + anchorEnd.getBoundingClientRect().width / 2) : null;
                const anchorStartText = (anchorStart?.textContent || '').trim();
                const anchorEndText = (anchorEnd?.textContent || '').trim();
                const anchorLeftInset = (anchorRect && anchorStartCenterViewport != null) ? Math.round(anchorStartCenterViewport - anchorRect.left) : 0;
                const anchorRightInset = (anchorRect && anchorEndCenterViewport != null) ? Math.round(anchorRect.right - anchorEndCenterViewport) : 0;
                const anchorRailWidth = (anchorRect ? Math.max(0, Math.floor(anchorRect.width - anchorLeftInset - anchorRightInset)) : 0);
                
                // 锚线站点位置映射：根据站序将同名站映射到[0,1]上的相对位置
                const anchorStationsRaw = anchorLine?.getAttribute('data-stations') || '';
                const anchorStations = anchorStationsRaw ? anchorStationsRaw.split('|').map(s => s.trim()).filter(Boolean) : [];
                const anchorPosMap = new Map();
                if (anchorStations.length > 1) {
                    anchorStations.forEach((name, idx) => anchorPosMap.set(name, idx / (anchorStations.length - 1)));
                }
                
                // 按锚线计算每条线路的目标轨宽，并分配缩进：
                routeLines.forEach((line, index) => {
                    const start = line.querySelector('.terminal-station:first-of-type');
                    const end = line.querySelector('.terminal-station:last-of-type');
                    if (!start || !end || !anchorRect) return;
                    
                    const lineRect = line.getBoundingClientRect();
                    const startRect = start.getBoundingClientRect();
                    const endRect = end.getBoundingClientRect();
                    
                    // 当前线路端点几何中心（用于初始inset）
                    const startCenter = Math.round(startRect.left - lineRect.left + startRect.width / 2);
                    const endCenter = Math.round(lineRect.right - (endRect.left + endRect.width / 2));
                    const startText = (start.textContent || '').trim();
                    const endText = (end.textContent || '').trim();
                    
                    // 目标轨宽：与锚线轨宽按总站数比例
                    const lengthRatio = maxTotal > 0 ? (effectiveTotals[index] / maxTotal) : 1;
                    const targetRailWidth = Math.max(0, Math.floor(anchorRailWidth * lengthRatio));
                    const shrink = Math.max(0, anchorRailWidth - targetRailWidth);
                    
                    // 基于站名在锚线上的位置进行对齐（优先），否则回退到端点对齐与平均缩进
                    // 环线特殊：避免用锚线站名对齐，直接以左右节点几何中心作为起止，并按比例收缩
                    let leftInset;
                    let rightInset;
                    if (line.classList.contains('loop')) {
                        leftInset = Math.max(0, startCenter);
                        rightInset = Math.max(0, endCenter);
                        const baseWidth = Math.max(0, Math.floor(lineRect.width - leftInset - rightInset));
                        const extraShrink = Math.max(0, baseWidth - targetRailWidth);
                        leftInset += Math.floor(extraShrink / 2);
                        rightInset += Math.ceil(extraShrink / 2);
                    } else {
                        leftInset = Math.max(0, startCenter);
                        rightInset = Math.max(0, endCenter);
                        const startPosRatio = anchorPosMap.has(startText) ? anchorPosMap.get(startText) : null;
                        const endPosRatio = anchorPosMap.has(endText) ? anchorPosMap.get(endText) : null;
                        const startPosPx = (startPosRatio != null) ? Math.round(anchorLeftInset + anchorRailWidth * startPosRatio) : null;
                        const endPosPx = (endPosRatio != null) ? Math.round(anchorLeftInset + anchorRailWidth * endPosRatio) : null;
                        if (startPosPx != null && endPosPx != null) {
                            // 两端都能在锚线上定位：严格按两点对齐
                            leftInset = Math.max(0, startPosPx);
                            rightInset = Math.max(0, Math.floor(lineRect.width - endPosPx));
                        } else if (startPosPx != null) {
                            // 仅起点可定位：起点贴齐，长度按比例
                            leftInset = Math.max(0, startPosPx);
                            rightInset = Math.max(0, Math.floor(lineRect.width - (leftInset + targetRailWidth)));
                        } else if (endPosPx != null) {
                            // 仅终点可定位：终点贴齐，长度按比例
                            rightInset = Math.max(0, Math.floor(lineRect.width - endPosPx));
                            leftInset = Math.max(0, Math.floor(lineRect.width - rightInset - targetRailWidth));
                        } else {
                            // 回退：端点同名则锁定到锚线端点中心，否则平均缩进
                            const alignLeftWithAnchor = (startText === anchorStartText);
                            const alignRightWithAnchor = (endText === anchorEndText);
                            if (alignLeftWithAnchor && anchorStartCenterViewport != null) {
                                leftInset = Math.max(0, Math.round(anchorStartCenterViewport - lineRect.left));
                                rightInset = Math.max(0, anchorRightInset + shrink);
                            } else if (alignRightWithAnchor && anchorEndCenterViewport != null) {
                                rightInset = Math.max(0, Math.round(lineRect.right - anchorEndCenterViewport));
                                leftInset = Math.max(0, anchorLeftInset + shrink);
                            } else {
                                leftInset = Math.max(0, anchorLeftInset + Math.floor(shrink / 2));
                                rightInset = Math.max(0, anchorRightInset + Math.ceil(shrink / 2));
                            }
                        }
                    }
                    // 让终点标签与轨道末端重合：用margin将标签中心对齐轨端
                    const startRectWidth = startRect.width;
                    const endRectWidth = endRect.width;
                    let startMarginLeft = Math.max(0, Math.round(leftInset - startRectWidth / 2));
                    let endMarginRight = Math.max(0, Math.round(rightInset - endRectWidth / 2));
                    const isLoopLine = line.classList.contains('loop');
                    const hasTerminal = (line.getAttribute('data-has-terminal') || '0') === '1';
                    if (isLoopLine && hasTerminal) {
                        const startCenterX = startMarginLeft + startRectWidth / 2;
                        const endCenterX = Math.max(0, Math.floor(lineRect.width - endMarginRight - endRectWidth / 2));
                        const minCenterGap = Math.max(startRectWidth, endRectWidth) + 12;
                        if ((endCenterX - startCenterX) < minCenterGap) {
                            startMarginLeft = 0;
                            endMarginRight = 0;
                            // 重新计算轨道缩进以对齐新的气泡中心
                            leftInset = Math.round(startRectWidth / 2);
                            rightInset = Math.round(endRectWidth / 2);
                        }
                    }

                    let railWidth = Math.max(0, Math.floor(lineRect.width - leftInset - rightInset));
                    
                    // 确保轨道（站点点位区域）有最小宽度，避免长站名挤压导致点位重叠
                    const minRailWidth = 120; 
                    if (railWidth < minRailWidth && lineRect.width > minRailWidth) {
                        const diff = minRailWidth - railWidth;
                        leftInset = Math.max(10, leftInset - diff / 2);
                        rightInset = Math.max(10, rightInset - diff / 2);
                        railWidth = Math.max(0, Math.floor(lineRect.width - leftInset - rightInset));
                    }

                    line.style.setProperty('--rail-left', leftInset + 'px');
                    line.style.setProperty('--rail-width', railWidth + 'px');

                    start.style.marginLeft = startMarginLeft + 'px';
                    end.style.marginRight = endMarginRight + 'px';
                    
                    const wrap = line.querySelector('.station-indicators');
                    if (wrap) {
                        wrap.style.left = leftInset + 'px';
                        wrap.style.right = rightInset + 'px';
                        
                        // 点数按比例（保持2-6上限）
                        const indicators = Array.from(wrap.querySelectorAll('.station-indicator'));
                        const originalCount = indicators.length;
                        let visibleCount = Math.max(2, Math.floor(originalCount * lengthRatio));
                        if (effectiveTotals[index] < maxTotal * 0.5) {
                            visibleCount = Math.max(2, Math.floor(originalCount * lengthRatio * 0.8));
                        }
                        
                        // 确保点之间有最小间距，防止重叠
                        const minDotGap = 24; 
                        const maxDotsBySpace = Math.floor(railWidth / minDotGap);
                        visibleCount = Math.max(2, Math.min(visibleCount, maxDotsBySpace));

                        wrap.classList.add('grid');
                        wrap.style.setProperty('--col-count', visibleCount);
                        indicators.forEach((el, idx) => {
                            if (idx < visibleCount) {
                                el.style.display = '';
                                el.style.gridColumn = (idx + 1).toString();
                                el.style.justifySelf = 'center';
                            } else {
                                el.style.display = 'none';
                            }
                        });
                    }
                });
            }
 
            // 初次布局
            layoutRouteLines();
 
            // 红点依次显示：让"下一站"红点在运营线路上顺序移动（只显示next，不显示active红点）
            const activeLine = document.querySelector('.route-line.active .station-indicators');
            if (activeLine) {
                const indicators = Array.from(activeLine.querySelectorAll('.station-indicator'));
                let cursor = 0;
                const step = () => {
                    indicators.forEach(i => i.classList.remove('next'));
                    indicators[cursor]?.classList.add('next');
                    cursor = (cursor + 1) % indicators.length;
                };
                step();
                setInterval(step, 900);
            }
 
            // 监听窗口尺寸变化，防止减小宽度后线路溢出
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    layoutRouteLines();
                }, 100);
            });
        }
    });
</script>
{% endblock %}
