{% extends 'base.html' %}

{% block title %}成都地铁PIS车内导视系统{% endblock %}

{% block page_title %}
    <div class="next-station-title">
        <span class="next-station-label">下一站</span>
        <span class="next-station-name">{{ next_station }}</span>
        <span class="next-station-name-en">{{ trans_data.get(next_station, next_station).replace('<br>', ' ') }}</span>
    </div>
{% endblock %}

{% block head %}
<style>
    .next-station-title {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }
    
    .next-station-label {
        font-size: 18px;
        color: #fff;
        opacity: 0.9;
    }
    
    .next-station-name {
        font-size: 32px;
        font-weight: bold;
        color: #fff;
    }
    
    .next-station-name-en {
        font-size: 16px;
        color: #fff;
        opacity: 0.8;
    }
    
    .route-info {
        margin: 30px 0;
    }
    
    .route-line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 20px 0;
        position: relative;
    }
    
    :root { --theme-color: #9b5de5; --dot-adjust: 2.5px; --rail-adjust: -2px; --rail-thickness: 10px; }
    .route-line::before {
        content: '';
        position: absolute;
        top: calc(50% + var(--rail-adjust, 0px));
        left: var(--rail-left, 0);
        width: var(--rail-width, 100%);
        height: var(--rail-thickness, 10px);
        background-color: #e0e0e0;
        z-index: 1;
    }
    /* 单节点（环线无终点）隐藏连线 */
    .route-line.single::before {
        display: none;
    }
    
    .route-line.active::before {
        background-color: var(--theme-color);
    }
    
    .route-line .terminal-station {
        font-size: 16px;
        font-weight: bold;
        padding: 5px 15px;
        background-color: white;
        border: 2px solid var(--theme-color);
        border-radius: 20px;
        z-index: 2;
    }
    
    .route-line.active .terminal-station {
        background-color: var(--theme-color);
        color: white;
    }
    
    .station-indicators {
        position: absolute;
        top: calc(50% + var(--rail-adjust, 0px) - calc(var(--rail-thickness, 10px) / 2) + var(--dot-adjust, 0px));
        left: 80px;
        right: 80px;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        z-index: 2;
        padding: 0; /* 去掉左右内边距，保证可用宽度与线路一致 */
        height: 0; /* 让容器无自身高度，确保绝对居中与轨道对齐 */
    }
    
    .station-indicator {
        width: 14px; /* 适当放大，较线宽更醒目 */
        height: 14px;
        border-radius: 50%;
        background-color: var(--theme-color);
        border: 2px solid #fff;
        position: relative;
        box-shadow: 0 0 0 2px var(--theme-color) inset;
        box-sizing: border-box; /* 尺寸包含描边，避免视觉偏差 */
    }
    
    /* 使用网格对齐：所有线路共享相同的列，保证纵向对齐 */
    .station-indicators.grid {
        display: grid;
        grid-template-columns: repeat(var(--col-count, 1), 1fr);
        align-items: center;
    }
    .station-indicators.grid .station-indicator {
        justify-self: center;
    }
    
    .station-indicator.next::before {
        content: '';
        width: 8px; /* 红点随主点比例略增大 */
        height: 8px;
        background-color: #ff3b30;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: blink 1s infinite alternate;
    }
    
    .route-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
    }
    
    .route-label.active {
        color: #9b5de5;
        font-weight: bold;
    }
    
    .terminal-info {
        text-align: right;
        margin-top: 20px;
        font-size: 16px;
        color: #666;
    }
    
    .terminal-info strong {
        color: #9b5de5;
        font-size: 18px;
    }
</style>
{% endblock %}

{% block content %}
    <!-- 路线信息展示（nextstation功能） -->
    <div class="route-info" style="--theme-color: {{ line_color or '#9b5de5' }};">
        {% if route_services %}
            {% set has_multiple = route_services|length > 1 %}
            {% for svc in route_services %}
                <div class="route-label {{ 'active' if svc.is_main else '' }}">运营线路{% if has_multiple %}{{ loop.index }}{% endif %}</div>
                <div class="route-line {{ 'active' if svc.is_main else '' }} {{ 'loop' if svc.is_loop else '' }} {{ 'single' if svc.is_loop and not svc.has_terminal else '' }}" data-total="{{ svc.total }}" data-stations="{{ (svc.stations or []) | join('|') }}">
                     <div class="terminal-station">{{ svc.start }}</div>
                      {% if not (svc.is_loop and not svc.has_terminal) %}
                     <div class="station-indicators">
                         {% for i in range(svc.count) %}
                         <div class="station-indicator"></div>
                         {% endfor %}
                     </div>
                     <div class="terminal-station">{{ svc.end }}</div>
                      {% endif %}
                 </div>
            {% endfor %}
        {% else %}
            <!-- 回退：仅渲染主运营线路 -->
            <div class="route-label active">运营线路</div>
            <div class="route-line active">
                <div class="terminal-station">{% if start_station %}{{ start_station }}{% endif %}</div>
                <div class="station-indicators">
                    {% for i in range(6) %}
                    <div class="station-indicator"></div>
                    {% endfor %}
                </div>
                <div class="terminal-station">{% if terminal_station %}{{ terminal_station }}{% endif %}</div>
            </div>
        {% endif %}
    </div>
    
    <div class="terminal-info">
        {% if route_services and route_services[0].is_loop %}
            {% if loop_terminal_main %}
                {{ loop_ring_label_main }} 终点站：<strong>{{ loop_terminal_main }}</strong>
            {% else %}
                <strong>{{ loop_ring_label_main }}</strong>
            {% endif %}
        {% else %}
            终点站: <strong>{% if terminal_station %}{{ terminal_station }}{% endif %}</strong>
        {% endif %}
    </div>
    
    <!-- 导航按钮 -->
    <div class="navigation-buttons" style="margin-top: 30px; display: flex; justify-content: center; gap: 20px;">
        <button class="btn" onclick="navigateTo('/line_map')">查看线路图</button>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('PIS车内导视系统首页加载完成');
        
        // 路线信息布局功能（nextstation功能）
        const routeInfo = document.querySelector('.route-info');
        if (routeInfo) {
            const theme = routeInfo?.style.getPropertyValue('--theme-color') || '#9b5de5';
            // 统一主题色描边
            document.querySelectorAll('.station-indicator').forEach(el => {
                el.style.borderColor = theme;
                el.style.boxShadow = '0 0 0 2px rgba(255,255,255,0.8) inset';
            });
            
            function layoutRouteLines() {
                const routeLines = Array.from(document.querySelectorAll('.route-line'));
                
                // 基于未截断的总站数计算线路的相对长度（来自data-total）
                const lineTotals = routeLines.map(line => {
                    const total = parseInt(line.getAttribute('data-total') || '0', 10);
                    return isNaN(total) ? 0 : total;
                });
                const maxTotal = Math.max(...lineTotals);
                
                // 选择"最长线路"作为锚线（不依赖active）
                let anchorIdx = lineTotals.indexOf(maxTotal);
                if (anchorIdx < 0) anchorIdx = 0;
                const anchorLine = routeLines[anchorIdx];
                const anchorStart = anchorLine?.querySelector('.terminal-station:first-of-type');
                const anchorEnd = anchorLine?.querySelector('.terminal-station:last-of-type');
                const anchorRect = anchorLine?.getBoundingClientRect();
                const anchorStartCenterViewport = anchorStart ? (anchorStart.getBoundingClientRect().left + anchorStart.getBoundingClientRect().width / 2) : null;
                const anchorEndCenterViewport = anchorEnd ? (anchorEnd.getBoundingClientRect().left + anchorEnd.getBoundingClientRect().width / 2) : null;
                const anchorStartText = (anchorStart?.textContent || '').trim();
                const anchorEndText = (anchorEnd?.textContent || '').trim();
                const anchorLeftInset = (anchorRect && anchorStartCenterViewport != null) ? Math.round(anchorStartCenterViewport - anchorRect.left) : 0;
                const anchorRightInset = (anchorRect && anchorEndCenterViewport != null) ? Math.round(anchorRect.right - anchorEndCenterViewport) : 0;
                const anchorRailWidth = (anchorRect ? Math.max(0, Math.floor(anchorRect.width - anchorLeftInset - anchorRightInset)) : 0);
                
                // 锚线站点位置映射：根据站序将同名站映射到[0,1]上的相对位置
                const anchorStationsRaw = anchorLine?.getAttribute('data-stations') || '';
                const anchorStations = anchorStationsRaw ? anchorStationsRaw.split('|').map(s => s.trim()).filter(Boolean) : [];
                const anchorPosMap = new Map();
                if (anchorStations.length > 1) {
                    anchorStations.forEach((name, idx) => anchorPosMap.set(name, idx / (anchorStations.length - 1)));
                }
                
                // 按锚线计算每条线路的目标轨宽，并分配缩进：
                routeLines.forEach((line, index) => {
                    const start = line.querySelector('.terminal-station:first-of-type');
                    const end = line.querySelector('.terminal-station:last-of-type');
                    if (!start || !end || !anchorRect) return;
                    
                    const lineRect = line.getBoundingClientRect();
                    const startRect = start.getBoundingClientRect();
                    const endRect = end.getBoundingClientRect();
                    
                    // 当前线路端点几何中心（用于初始inset）
                    const startCenter = Math.round(startRect.left - lineRect.left + startRect.width / 2);
                    const endCenter = Math.round(lineRect.right - (endRect.left + endRect.width / 2));
                    const startText = (start.textContent || '').trim();
                    const endText = (end.textContent || '').trim();
                    
                    // 目标轨宽：与锚线轨宽按总站数比例
                    const lengthRatio = maxTotal > 0 ? (lineTotals[index] / maxTotal) : 1;
                    const targetRailWidth = Math.max(0, Math.floor(anchorRailWidth * lengthRatio));
                    const shrink = Math.max(0, anchorRailWidth - targetRailWidth);
                    
                    // 基于站名在锚线上的位置进行对齐（优先），否则回退到端点对齐与平均缩进
                    // 环线特殊：避免用锚线站名对齐，直接以左右节点几何中心作为起止，并按比例收缩
                    let leftInset;
                    let rightInset;
                    if (line.classList.contains('loop')) {
                        leftInset = Math.max(0, startCenter);
                        rightInset = Math.max(0, endCenter);
                        const baseWidth = Math.max(0, Math.floor(lineRect.width - leftInset - rightInset));
                        const extraShrink = Math.max(0, baseWidth - targetRailWidth);
                        leftInset += Math.floor(extraShrink / 2);
                        rightInset += Math.ceil(extraShrink / 2);
                    } else {
                        leftInset = Math.max(0, startCenter);
                        rightInset = Math.max(0, endCenter);
                        const startPosRatio = anchorPosMap.has(startText) ? anchorPosMap.get(startText) : null;
                        const endPosRatio = anchorPosMap.has(endText) ? anchorPosMap.get(endText) : null;
                        const startPosPx = (startPosRatio != null) ? Math.round(anchorLeftInset + anchorRailWidth * startPosRatio) : null;
                        const endPosPx = (endPosRatio != null) ? Math.round(anchorLeftInset + anchorRailWidth * endPosRatio) : null;
                        if (startPosPx != null && endPosPx != null) {
                            // 两端都能在锚线上定位：严格按两点对齐
                            leftInset = Math.max(0, startPosPx);
                            rightInset = Math.max(0, Math.floor(lineRect.width - endPosPx));
                        } else if (startPosPx != null) {
                            // 仅起点可定位：起点贴齐，长度按比例
                            leftInset = Math.max(0, startPosPx);
                            rightInset = Math.max(0, Math.floor(lineRect.width - (leftInset + targetRailWidth)));
                        } else if (endPosPx != null) {
                            // 仅终点可定位：终点贴齐，长度按比例
                            rightInset = Math.max(0, Math.floor(lineRect.width - endPosPx));
                            leftInset = Math.max(0, Math.floor(lineRect.width - rightInset - targetRailWidth));
                        } else {
                            // 回退：端点同名则锁定到锚线端点中心，否则平均缩进
                            const alignLeftWithAnchor = (startText === anchorStartText);
                            const alignRightWithAnchor = (endText === anchorEndText);
                            if (alignLeftWithAnchor && anchorStartCenterViewport != null) {
                                leftInset = Math.max(0, Math.round(anchorStartCenterViewport - lineRect.left));
                                rightInset = Math.max(0, anchorRightInset + shrink);
                            } else if (alignRightWithAnchor && anchorEndCenterViewport != null) {
                                rightInset = Math.max(0, Math.round(lineRect.right - anchorEndCenterViewport));
                                leftInset = Math.max(0, anchorLeftInset + shrink);
                            } else {
                                leftInset = Math.max(0, anchorLeftInset + Math.floor(shrink / 2));
                                rightInset = Math.max(0, anchorRightInset + Math.ceil(shrink / 2));
                            }
                        }
                    }
                    const railWidth = Math.max(0, Math.floor(lineRect.width - leftInset - rightInset));
                    line.style.setProperty('--rail-left', leftInset + 'px');
                    line.style.setProperty('--rail-width', railWidth + 'px');

                    // 让终点标签与轨道末端重合：用margin将标签中心对齐轨端
                    const startRectWidth = startRect.width;
                    const endRectWidth = endRect.width;
                    const startMarginLeft = Math.max(0, Math.round(leftInset - startRectWidth / 2));
                    const endMarginRight = Math.max(0, Math.round(rightInset - endRectWidth / 2));
                    start.style.marginLeft = startMarginLeft + 'px';
                    end.style.marginRight = endMarginRight + 'px';
                    
                    const wrap = line.querySelector('.station-indicators');
                    if (wrap) {
                        wrap.style.left = leftInset + 'px';
                        wrap.style.right = rightInset + 'px';
                        
                        // 点数按比例（保持2-6上限）
                        const indicators = Array.from(wrap.querySelectorAll('.station-indicator'));
                        const originalCount = indicators.length;
                        let visibleCount = Math.max(2, Math.floor(originalCount * lengthRatio));
                        if (lineTotals[index] < maxTotal * 0.5) {
                            visibleCount = Math.max(2, Math.floor(originalCount * lengthRatio * 0.8));
                        }
                        wrap.classList.add('grid');
                        wrap.style.setProperty('--col-count', visibleCount);
                        indicators.forEach((el, idx) => {
                            if (idx < visibleCount) {
                                el.style.display = '';
                                el.style.gridColumn = (idx + 1).toString();
                                el.style.justifySelf = 'center';
                            } else {
                                el.style.display = 'none';
                            }
                        });
                    }
                });
            }
 
            // 初次布局
            layoutRouteLines();
 
            // 红点依次显示：让"下一站"红点在运营线路上顺序移动（只显示next，不显示active红点）
            const activeLine = document.querySelector('.route-line.active .station-indicators');
            if (activeLine) {
                const indicators = Array.from(activeLine.querySelectorAll('.station-indicator'));
                let cursor = 0;
                const step = () => {
                    indicators.forEach(i => i.classList.remove('next'));
                    indicators[cursor]?.classList.add('next');
                    cursor = (cursor + 1) % indicators.length;
                };
                step();
                setInterval(step, 900);
            }
 
            // 监听窗口尺寸变化，防止减小宽度后线路溢出
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    layoutRouteLines();
                }, 100);
            });
        }
    });
</script>
{% endblock %}